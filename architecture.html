<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Architecture - Worldpay Within</title>
    <link rel="stylesheet" href="css/foundation.css">
    <link rel="stylesheet" href="css/app.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">    
  </head>
  <body>
    <div class="row">
      <div class="large-12 columns">
        <img style="padding-top: 5px; padding-bottom: 5px;" src="/images/worldpaylogosmall.png" alt="Worldpay Logo"/>
        <div style="padding-left: 5px; color: white; background-color: red;"><a href="/"><h1 style="font-size: 1.8em !important;">Worldpay Within Documentation</h1></a></div>
      </div>
    </div>

    <div class="row">
      <div class="large-12 columns">
        <div class="callout">
          
                <form>
                  <div class="row">
                    <div class="large-12 columns">
                      <label>Search for a topic or question</label>
                    </div>
                    <div class="large-12 columns">
                      <input type="text" placeholder="Search for a topic or question" />
                    </div>
                  </div>
                </form>


              <div class="row">
            
                    <div class="large-12 columns">
<!-- Insert page content below -->




                              <h2>The Worldpay Within Architecture</h2>







<h3>Architecture Overview</h3>


<p><img src="/img/worldpayWithinFig1.png" alt="">
In the IoT, each Thing will perform the function it is designed for be it
acting as a sensor, or a controller or both. In order for Thing to be
able to make and receive payments for services they can provide to other
Things, they need to add the payments functionality contained in
Worldpay Within.</p>

<p><img src="media/image3.emf" alt="">Things in the IoT will be implemented on
dedicated low cost processor systems. The Thing and Worldpay Within must
co-exist and operate on the resources provided by these devices, as
demonstrated in Figure 2.</p>

<p>In order to make and receive payments in the IoT, a Thing must be able
to perform the roles of “consumer”, to make a payment for services, and
the “merchant”, to receive a payment for provision of services. In the
Worldpay Within IoT architecture, the “consumer” pays for services by
supporting Host Card Emulation (HCE). The “merchant” receives payments
for services by supporting Host Terminal Emulation (HTE). Worldpay
Within contains both an HCE Brain &amp; HTE Brain functionalities, ensuring
a Thing can both consume and supply services. These services are
provided through a series of public APIs, described within this
document.</p>

<p>HCE and HTE require the secure storage and use of the credentials during
the payments process. This necessitates the use of secure processing
within the Thing in a “Secure Execution Environment”.</p>

<p>For HCE Things, these credentials include the details of the “card”
which the payment will be made from. For HTE Things, these credentials
include the details the Merchant requires to perform transactions in
Online.worldpay.com.</p>

<p>As well as the provision of the payment for the services, Worldpay
Within provides for the generation and validation of secure service
tokens, which allow for services to be consumed in part or together, but
separately from the payments functionality.</p>

<h2 id="secure-messaging">Secure Messaging</h2>

<p>Online.worldpay.com provides a secure payments interface with devices
connecting to Online.worldpay.com using Transport Layer Security (TLS).
The payment process involves the sending of payment credentials to
Online.worldpay.com from the IoT Thing. In order to ensure the
credentials are not exposed, the IoT Thing must ensure that these
credentials are only available within a Secure Execution Environment
(SEE) within the Thing, and that they are protected at all points
between the SEE and Online.worldpay.com. There are several architecture
considerations <img src="media/image4.emf" alt="">to achieving this security, as shown in
Figure 2, dependent on the platform chosen for the IoT Thing.</p>

<p>Ideally the TLS connection would be secured from within the SEE, however
this may not be possible due to the hardware constraints. In this case,
the implementation of TLS within the Thing should be split to ensure
that the data encryption services are performed from within the SEE. If
this is not possible, then a P2PE service layer may be required to
secure the data from the SEE to Online.worldpay.com.</p>

<h3 id="credential-provisioning">Credential provisioning</h3>

<p>When each IoT Brain is personalised with its Online.worldpay.com payment
credentials, the card details should be Tokenised and channel restricted
to Online.worldpay.com.</p>

<h3 id="implementation">Implementation</h3>

<p>Devices used in the IoT are lower end processors with limited processing
power and memory. In order to minimise the impact on the device,
implementations of Worldpay Within for IoT devices will be programmed in
C or C# language.</p>

<p>The messaging shall be based on Java Script Object Notation (JSON)[^2]
rather than the more common (e.g. EMV) Application Protocol Data Units
(APDU) as the project will already need to use JSON to communicate with
Online.worldpay.com REST-full[^3] back end. There are a number of
implementations of JSON available in C or C# suitable for the proposed
IoT platforms.</p>


<h1>Worldpay Within IoT Service Architeture</h1>

<p><img src="media/image5.emf" alt="">{width=”6.497916666666667in” height=”6.4375in”}The
provision of a service within the Worldpay IoT system is performed in 4
phases, as shown in Figure 3, these being: Service Discovery; Service
Negotiation; Payment; and Service Delivery. Each of these phases are
described in the following sections.</p>

<h2 id="service-discovery">Service Discovery</h2>

<p>Each Thing that offers services, the service ‘supplier’ shall broadcast
it’s list of available services, as shown in Figure 4 below. When a
potential ‘consumer’ of the service connects with ‘supplier’ it can
request details of the services offered.</p>

<p><img src="media/image6.emf" alt="">{width=”4.59375in”
height=”2.3854166666666665in”}Providing a suitable service is
discovered, the consumer then requests the service from the supplier,
and price negotiations can begin.</p>

<h3 id="service-discovery-apis">Service Discovery APIs</h3>

<p><strong>Key</strong>              <strong>Parameters</strong>                   <strong>Purpose</strong>
  ——————– ——————————– —————————————————————————–
  broadcast            server_UUID                     Advertising services and identifying the sender
  request services     &lt;none&gt;                     Request a list of all services
  services_response   list of services, server_UUID   Provide client with a list of possible services that the sender can provide</p>

<h3 id="service-discovery-messages">Service discovery messages</h3>

<p>A broadcast message that includes Thing B’s UUID is sent.</p>

<p>Upon receiving the message Thing A connects to Thing B and requests the
list of available services.</p>

<p>Thing B responds with a list identifying the services available.</p>

<h2 id="service-negotiation">Service Negotiation</h2>

<p><img src="media/image7.emf" alt="">{width=”4.802083333333333in”
height=”2.6979166666666665in”}Once a suitable service has been
discovered, there will be a price negotiation. The provider may offer
the same service at different rates depending on the number of units of
service to be purchased. The process is outlined in Figure 5. The
outcome of the process is an agreement to purchase an amount of service
and a total price for the service to be provided. The service provider
can then request payment for the agreed service and price.</p>

<h3 id="service-negotiation-apis">Service Negotiation APIs</h3>

<hr>
<p><strong>Key</strong>                   <strong>Parameters</strong>                                                                                                    <strong>Purpose</strong>
  ————————- —————————————————————————————————————– ———————————————————————————————————–
  price_request            service_id                                                                                                       Request a list of all prices for a given service.</p>

<p>price_response           server_UUID, list of prices,                                                                                     Provide the client with a list of prices for a given service. A price object contains the per unit price.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                        (service\_id, price\_id, price\_per\_unit, unit\_ID, unit\_description, price\_description)                       
</code></pre>
</div>

<p>price_select             service_id, price_id, number_of_units, client_UUID                                                           Select a price with price_id, for service_id for a number of units.</p>

<p>price_select_response   price_id, number_of_units, total_price, server_UUID, client_UUID, payment_ref_ID, Merchant_Client_key   Communicate the expected total price to the client.
  ——————————————————————————————————————————————————————————————————————————————————-</p>

<h3 id="service-negotiation-messages">Service negotiation messages</h3>

<p>A price request is sent containing the selected service_id.</p>

<p>The response from Thing B contains a list of price items; each item
should contain a price_id, per unit price, unit_ID and description
fields of both the unit and the price.</p>

<p>Thing A then selects an appropriate price_id by sending a request with
its client_UUID, the selected service_id, the price_id, and the
number of items required.</p>

<p>If the number of items falls within the correct number of items for the
price selected, then Thing B responds with a price select response
containing the service_id, price_id, the total price, the
service_UUID and a reference for the payment and its Merchant Client
key. Otherwise Thing B shall return the number of units it can supply
along with the correct price, and additional details required to
initiate the payment.</p>

<h2 id="payment">Payment</h2>

<p>The payment process with Online.worldpay.com is a two stage process,
split between the consumer and merchant Things involved in the
transaction, these stages are:</p>

<ul>
  <li>
    <p>Client Token Request, and</p>
  </li>
  <li>
    <p>Payment Authorisation Request. (Also known as Order Request)</p>
  </li>
</ul>

<p>During the first stage, the consumer sends Online.worldpay.com their
payment credentials and the merchants Client Key. Online.worldpay.com
returns a Client Token, which the consumer passes to the Merchant,
allowing the merchant to perform the payment authorisation request with
Online.worldpay.com by providing the Client Token and transaction
details.</p>

<p>This payment process ensures that the consumer does not pass their
payment credentials to the merchant, only to Online.worldpay.com.</p>

<h3 id="client-token-request">Client token request</h3>

<p><img src="media/image8.emf" alt="">{width=”5.40625in”
height=”2.6666666666666665in”}The first step in the payment process is
when Thing A receives the Merchant_Client_Key from Thing B. Thing B
passes their public Client Key to Thing A as part of the
price_select_response during the Service Negotiation phase. Upon
receiving the Client Key from Thing B, Thing A connects with
Online.worldpay.com to request the client token from
Online.worldpay.com. This request includes Thing A’s payment
credentials: Card PAN, expiry, and the client_key of Thing B.
Online.worldpay.com will respond with a message that includes a
client_token. This is shown in Figure 6.</p>

<h3 id="client-token-request-apis">Client token request APIs</h3>

<h4 id="thing-a-to-onlineworldpaycom-client-token-request">Thing A to Online.worldpay.com client token request</h4>

<hr>
<p><strong>Key</strong>                   <strong>Parameters</strong>                                                                                                                                                                                                                                                           <strong>Purpose</strong>
  ————————- ———————————————————————————————————————————————————————————————————————————————————————— ———————————————————————————————————————
  client_token_request    Payment_method, reusable_flag, Merchant_client_key                                                                                                                                                                                                                   Request a client token from Online.worldpay.com, whilst providing Online.worldpay.com with the payment credentials.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                        Payment\_method (name, PAN, expiryMonth, expiryYear, type)                                                                                                                                                                                                               
</code></pre>
</div>

<p>client_token_response   client_token, reusable_flag, payment_method_response                                                                                                                                                                                                                 Response from Online.worldpay.com containing the client_token.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                        (type, name, expiryMonth, expiryYear, card\_type, card\_scheme\_type, card\_scheme\_name, masked\_card\_number, card\_product\_type\_description\_non\_contactless, card\_product\_type\_description\_contactless, card\_issuer, country\_code, card\_class, pre-paid)   
</code></pre>
</div>

<p>Payment_request          client_token, client_UUID, payment_ref_ID                                                                                                                                                                                                                            The client_token is passed to Thing B to allow the 2^nd^ part of the transaction process to take place.
  ————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————</p>

<p>Thing A will connect to Online.worldpay.com using TLS. It will then
request a client_token by securely (see 2.2.1) sending a JSON message
containing the paymentMethod, its payment credentials (PAN, expiry) to
Online.worldpay.com along with the client_ key from Thing B. In
addition a flag indicating if the client details can be used in future
is sent, for IoT this should always be set ‘reusable’:’false’ in order
to force generation of a new client token for each transaction.</p>

<p>A successful response will be an HTTP POST response containing fields:
client_token, reusable_flag and the payment_method_response. Once
received, the client_token shall be passed to Thing B</p>

<p>A sample request is shown in Appendix B: Sample Service Messaging.</p>

<p>See Online.worldpay.com documentation for client_token_request &amp;
client_token_repsonse APIs data descriptions.</p>

<h3 id="payment-authorisation-request">Payment authorisation request</h3>

<p>Thing B will process the order and request the payment from
Online.worldpay.com providing its Service key, client_token,
transaction currency and payment amount. This is transmitted to
Online.worldpay.com over TLS. After successful processing
Online.worldpay.com will provide a payment response. Thing B shall then
generate a service token, which Thing A may use in future to obtain the
services that the payment has been made for. This is shown in Figure 7.</p>

<h3 id="mediaimage9emfwidth625in-height24166666666666665inpayment-authorisation-request-apis"><img src="media/image9.emf" alt="">{width=”6.25in” height=”2.4166666666666665in”}Payment authorisation request APIs</h3>

<h4 id="thing-b-to-onlineworldpaycom-payment-authorisation-request">Thing B to Online.worldpay.com payment authorisation request</h4>

<hr>
<p><strong>Key</strong>           <strong>Parameters</strong>                                                                                                                                                                                                                                                           <strong>Purpose</strong>
  —————– ———————————————————————————————————————————————————————————————————————————————————————— ——————————————————————————————-
  order_request    client_service_key, client_token, currency_code, amount, order_description, customer_order_code                                                                                                                                                                   Request payment from Online.worldpay.com.</p>

<p>order_response   order_code, client_token, order_description, amount, currency_code, payment_status, customer_order_code, environment, risk_score, payment_response                                                                                                              Payment response indicating a successful transaction on the Online.worldpay.com platform.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                (type, name, expiryMonth, expiryYear, card\_type, card\_scheme\_type, card\_scheme\_name, masked\_card\_number, card\_product\_type\_description\_non\_contactless, card\_product\_type\_description\_contactless, card\_issuer, country\_code, card\_class, pre-paid)      --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</code></pre>
</div>

<p>Thing B shall assemble a message to be posted to Online.worldpay.com
that contains the client token, Service key, the amount, currency and
transaction description. Online.worldpay.com shall then perform an
authorisation using the payment credentials identified by the
client_token. A successful authorisation will result in a
payment_status of SUCCESS being returned to Thing B.</p>

<h4 id="thing-b-to-thing-a-service-token">Thing B to Thing A service token</h4>

<p><strong>Key</strong>                      <strong>Parameters</strong>                                                      <strong>Purpose</strong>
  —————————- ——————————————————————- ———————————————–
  payment_request_response   service_delivery_token, server_UUID, client_UUID, total_paid   service_delivery_token is passed to ThingB.</p>

<p>Thing B shall then generate a cryptographically secure
service_delivery_token, which can be used by Thing A to request
provision of services from Thing B.</p>

<h2 id="service-delivery">Service Delivery</h2>

<p><img src="media/image10.emf" alt="">{width=”3.8020833333333335in”
height=”3.3333333333333335in”}Once the payment has been made, Thing B
shall return to broadcasting its available services. Thing A will now be
able to consume the service from Thing B by providing the
service_delivery_token. The service delivery may be in a single step,
or over time. An overview of service delivery is shown in Figure 8.</p>

<p>Once in possession of a service_token, Thing A may then request the
service be provided. The service could be consumed in one session, or in
several sessions over time, depending on the nature of the service and
number of units purchased. Thing A may repeatedly send service delivery
requests until Thing B indicates that the service has been delivered.</p>

<h3 id="service-delivery-apis">Service Delivery APIs</h3>

<p><strong>Key</strong>                     <strong>Parameters</strong>                                                                                                          <strong>Purpose</strong>
  ————————— ———————————————————————————————————————– ——————————————————————————————————————————————-
  broadcast                   server_UUID                                                                                                            Advertising services and identifying the sender.
  delivery_begin_request    service_delivery_token, client_UUID, number_of_units_to_supply                                                   Request the service item, with the service_delivery_token providing right to receive the service, and amount of service to be supplied.
  delivery_begin_response   server_UUID, service_delivery_token, client_UUID, number_of_units_to_be_supplied                               Response for the service delivery. Confirmation of number of service units to be supplied (Allowing for less units than requested).
  delivery_end               client_UUID, number_of_units_received                                                                               Confirmation of service received.
  delivery_end_response     server_UUID, service_delivery_token, client_UUID, number_of_units_just_supplied, number_of_units_remaining   Service end indicating outstanding service credits and token for subsequent delivery.</p>

<p>Thing A sends a message with the service_delivery_token to Thing B,
along with the amount of service it wishes to consume. The response
shall confirm the amount of service units that Thing B can supply to
Thing A at that time. Once the service has been delivered, Thing A shall
confirm the amount of service units it has received, with Thing B
responding, stating the number of units still remaining to Thing A, if
any.</p>

  


































                              <p>Worldpay Within SDK to allow payments within IoT.</p>

                              <p>The core of this SDK is written in Go with a native Go interface. Along with the native Go interface is an RPC layer (Apache Thrift) to allow communication through other languages. It is intended that we will develop a number of complementary wrapper libraries for other languages which should include C#.NET, Java, Python at a minimum.</p>

                              <a href="/getting-started.html" class="alert button">Getting started guide</a>
                              <a href="/getit.html" class="alert button">Get the SDK</a>    

                              <h3>What is Worldpay Within and what does Worldpay within do</h3>
                              
                              <p>Worldpay is an embeddable payments agent, for the Internet of Things (IoT) that can be 'plugged' into your app for a smart device, enabling it to discover services of other devices, pay for those services, and then consume those services. Conversely it also allows your smart device to expose services to consumers, receive payments for those services, and then release services to a consumer using the idea of a 'Trusted Trigger'.</p>

                              <p>It is all about enabling payments in IoT, and allowing smart devices to communicate with each other and exchange value for services in IoT</p>

                              <p>So a consumer is a smart device which is looking for services, pays for services and consumes services</p>

                              <p>On the other hand a producer is a smart device that is able to advertise availability of it's owner services to consumers, then negogiate a payment, take a payment, and release those services to the trusted consumer that made the payment</p>

                              <div style="text-align: center;"><figure>
                                  <img style="padding-top: 25px;" src="/images/intro/what-worldpay-within-does.JPG" alt="What Worldpay Within Does"/>
                                  <figcaption>What Worldpay Within Does.</figcaption>
                              </figure></div>

                              <p>The use case shown in the example above has a smart car looking for parking, and paying a smart parking meter for parking in it's parking bay. The smart car "wants to park", so has HCE (Host Card Emulation; card credentials), it acts as a shopper. When trying to make a payment, it will go off to the Worldpay online payments gateway and request tokenised card credentials based on the smart device it is trying to consume services from.</p>

                              <p>This token is then securely passed to the parking meter. In this case the parking meter is the Producer, or is acting as the merchant, or HTE (Host Terminal Emulation, accepting payment), which then directly communicates with the online Worldlpay gateway to make a 'card on file' or 'eCommerce' type payment authorisation request. With the payment authorised it then releases the purhcased service to the consumer.</p>

                              <p>The beauty of Worldpay Within is that it enables smart devices to both make payments and receive payments. In this example above the parking meter could then go on to make payments to the electricity companies smart hub which is powering it.</p>

                              <h3>How the Wrapper works</h3>

                              <div style="text-align: center;"><figure>
                                  <img style="padding-top: 25px;" src="/images/intro/how-the-wrapper-works.JPG" alt="How the Wrapper Works"/>
                                  <figcaption>How the Wrapper Works.</figcaption>
                              </figure></div>

                              <p>On the left handside you have the SDK, on the right hand side you have the Wrapper, in this case the Java Core. The SDK in Golang has an RPC layer on top which is exposed via Thrift. The Java Core or Wrapper, is built up of the Thrift layer which does the RPC comms to the core SDK. Plus the wrapper acts as an adpater converting all the data / objects / errors into Pojos that the Java core, or the app you are building can work with.</p>

                              <p>The important thing to recognise here is that none of the Thrift layer is exposed to you as a developer, and all the RPC calls are handled for you, so essentially you are calling the Worldpay Within seamlessly, managed by the Worldpay Within Wrapper in the appropriate language you are working in</p>

                              <h3>How the wrapper and SDK work</h3>

                              <div style="text-align: center;"><figure>
                                  <img style="padding-top: 25px;" src="/images/intro/how-the-wrapper-and-sdk-work.JPG" alt="How the wrapper and SDK work"/>
                                  <figcaption>How the wrapper and SDK work.</figcaption>
                              </figure></div>

                              <p>This is another view on the SDK and the app - this scenario there are two devices with Worldpay Within installed on them, and they communicate over the internet. You'll note that one is the 'consumer' and the other is the 'producer', as explained above. Now as you go down the layers, you have the RPC layer, then the Thrift layer and finally the wrapper layer, which is above to communicate with the SDK via RPC calls, what is not shown is your app will be the next layer shown on the diagram.</p>

                              <p>In this scenario, the producer is UDP broadcasting a service message, which includes what it's hostname, IP and UrlPrefix are. Once the consumer does device discovery, it is able to communicate over HTTP with the restful endpoint on the producer to find out what services it offers, and then begins the rest of the flow</p>
                             
                              <h3>What's happening inside the SDK</h3>

                              <p>Certainly for the first release, we have open sourced the wrappers and example apps, but kept the internals of the Golang SDK closed source, however with the appropriate success of the project, we shall consider open sourcing this component too.</p>

                              <p>It is useful, of course, to know exactly what is happening inside this black box, so the following details the architecure of Worldpay Within and what is happening in the internals</p>

                              <a href="/architecture.html" class="alert button">The Worldpay Within Architecture</a>   


<!-- Insert page content above -->
                    </div>                       
              </div>
            </div>
        </div>
     </div>



<!--
        
            

  
        <



-->



    <script src="js/vendor/jquery.js"></script>
    <script src="js/vendor/what-input.js"></script>
    <script src="js/vendor/foundation.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
